{% extends 'layout_login.html' %}

{% block stylesheet %}
		<link href="{{ url_for('static', filename='css/videojs/video-js.min.css') }}" rel="stylesheet">
		<link href="{{ url_for('static', filename='css/videojs/videojs.wavesurfer.min.css') }}" rel="stylesheet">
		<link href="{{ url_for('static', filename='css/videojs/videojs.record.min.css') }}" rel="stylesheet">
{% endblock %}

{% block script %}
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/video.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/adapter.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/recorder.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/wavesurfer.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/wavesurfer.microphone.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.wavesurfer.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.record.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.record.recorderjs.min.js') }}"></script>
		<script type="text/javascript">
// 문제 파일
var probFileList = [];
probFileList.push("/static/audio/audio_sample.wav");
probFileList.push("/static/audio/hal.wav");
// 녹음 파일
var submitDataList = [];

// 플레이어
var exampleAudioPlayer;
var submitAudioPlayer;
var fd;
var submitSeq = "";
$(document).ready(function(){
        // 원음
        const sampleAudioOptions = {
                controls: true,
                autoplay: false,
                fluid: false,
                bigPlayButton: false,
                plugins: {
                        wavesurfer: {
                                backend: 'MediaElement',
                                displayMilliseconds: false,
                                debug: true,
                                waveColor: '#086280',
                                progressColor: 'black',
                                cursorColor: 'black',
                                hideScrollbar: true
                        }
                }
        };
        exampleAudioPlayer = videojs('exampleAudioWaveSurfer', sampleAudioOptions, function() {
		// 1번문제 세팅
		exampleAudioPlayer.src({src: probFileList[0], type: 'audio/wav'});
//		exampleAudioPlayer.src({src: "{{ url_for('static', filename=wav_url) }}", type: 'audio/wav'});
        });

        exampleAudioPlayer.on("ended", function(){
                // 녹음 끝났을떄
                if($(".simultaneousBtn").length > 0){
                        var btnEle = $(".sequentialBtn");
                        exampleAudioPlayer.pause();
                        exampleAudioPlayer.currentTime(0)
                        submitAudioPlayer.record().stop();
                        btnEle.removeClass("recoding");
                        btnEle.text("통역시작");
                }
        });

        // 녹음
        var submitAudioOptions = {
                controls: true,
                bigPlayButton: false,
                fluid: false,
                plugins: {
                        wavesurfer: {
                                backend: 'WebAudio',
                                waveColor: '#6fffe9',
                                progressColor: 'black',
                                displayMilliseconds: true,
                                debug: true,
                                cursorWidth: 1,
                                hideScrollbar: true,
                                plugins: [
                                        WaveSurfer.microphone.create({
                                                bufferSize: 4096,
                                                numberOfInputChannels: 1,
                                                numberOfOutputChannels: 1,
                                                constraints: {
                                                        video: false,
                                                        audio: true
                                                }
                                        })
                                ]
                        },
                        record: {
                                audio: true,
                                video: false,
                                maxLength: 600,
                                displayMilliseconds: true,
                                debug: true,
                                audioEngine: 'recorder.js'
                        }
                }
        };
        submitAudioPlayer = videojs('submitAudioWaveSurfer', submitAudioOptions, function() {
        });

        submitAudioPlayer.on('ready', function(){
                submitAudioPlayer.record().getDevice();
        });

        submitAudioPlayer.on('deviceError', function() {
		alert('지원하지 않는 장비입니다.');
                console.log('device error:', submitAudioPlayer.deviceErrorCode);
        });

        submitAudioPlayer.on('error', function(element, error) {
                console.error(error);
        });

        submitAudioPlayer.on('startRecord', function() {
                console.log('started recording!');
        });

        submitAudioPlayer.on('finishRecord', function() {
                console.log('finished recording: ', submitAudioPlayer.recordedData);
        });

        // 동시 통역
        $(document).on("click", ".simultaneousBtn", function(){
                var btnEle = $(this);

                if(!btnEle.hasClass("recoding")){
                        // 녹음시작
                        exampleAudioPlayer.play();
                        submitAudioPlayer.record().start();
                        btnEle.addClass("recoding");
                        btnEle.text("녹음중/취소");
                }else{
                        // 녹음아님
                        exampleAudioPlayer.pause();
                        exampleAudioPlayer.currentTime(0)
                        submitAudioPlayer.record().stop();
                        btnEle.removeClass("recoding");
                        btnEle.text("통역시작");
                }
        });

        // 녹음본 제출
        $(document).on("click", ".recordTempSaveBtn", function(){
                // 녹음 데이터 보내기
		console.log("녹음 임시저장중");
                fd = new FormData();
                fd.append('wav', submitAudioPlayer.recordedData);
                $.ajax({
                        url: "/stt",
                        type: "PUT",
                        data: fd,
                        processData: false,
                        contentType: false
                }).done(function(data){
			submitDataList.push(data.file);
			// 다음문제 세팅
			if(probFileList.length == submitDataList.length){
				// 문제 모두 녹음됬을때
				alert("녹음이 완료되었습니다.\n제출버튼을 눌러주세요");
			}else{
				exampleAudioPlayer.src({src: probFileList[submitDataList.length], type: 'audio/wav'});
				alert(submitDataList.length + "번 녹음 완료");
			}
                });
        });

	$(document).on("click", ".submitRecordDataBtn", function(){
		if(probFileList.length != submitDataList.length){
			alert("모든 문제를 녹음해주세요");
		}else{
			var submitUUID = [];
			for(var i=0; i<submitDataList.length; i++){
				submitUUID.push(submitDataList[i]);
			}
			var param = {
				"submitUUID": submitUUID,
				"as_no": ""
			};

			$.ajax({
				url: "/",
				type: "POST",
				headers: {'Content-Type': 'application/json'},
				data: JSON.stringify(param),
				success: function(d){
					// pass
				}
			});
/*
			$.ajax({
				url: "/stt",
				type: "POST",
				data: "file=" + submitSeq,
				success: function(d){
					console.log(d);
					setTimeout(function(){
						$.ajax({
							url: "/stt/" + d.job,
							type: "GET",
							success: function(e){
								alert(decodeURIComponent(e.textFile));
							}
						});
					}, 5000);
				}
			});*/
		}
	});
});
		</script>
{% endblock %}

{% block content %}
			<div class="contentDiv">
				<h1>동시 통역/순차 통역</h1>
				<div class="probKeywordDiv">
					<span>문제 키워드 : 테스트 키워드</span>
				</div>
				<div class="exampleAudioDiv">
					<h2>원음</h2>
					<audio id="exampleAudioWaveSurfer" class="video-js vjs-default-skin"></audio>
				</div>
				<div class="submitAudioDiv">
					<h2>내음성</h2>
					<audio id="submitAudioWaveSurfer" class="video-js vjs-default-skin"></audio>
				</div>
				<div class="recordControllerDiv">
					<!--button class="btn sequentialBtn">통역 시작</button-->
					<button class="btn simultaneousBtn">통역 시작</button>
				</div>
				<div class="recordBtnDiv btnDiv btn-2 btn-align-right">
					<button class="btn btn-temp recordTempSaveBtn">임시저장</button>
					<button class="btn btn-submit submitRecordDataBtn">제출</button>
				</div>
			</div>
{% endblock %}
