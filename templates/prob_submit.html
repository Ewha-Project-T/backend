{% extends 'layout_login.html' %}

{% block stylesheet %}
		<link href="{{ url_for('static', filename='css/videojs/video-js.min.css') }}" rel="stylesheet">
		<link href="{{ url_for('static', filename='css/videojs/videojs.wavesurfer.min.css') }}" rel="stylesheet">
		<link href="{{ url_for('static', filename='css/videojs/videojs.record.min.css') }}" rel="stylesheet">
{% endblock %}

{% block script %}
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/video.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/adapter.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/recorder.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/wavesurfer.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/wavesurfer.microphone.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.wavesurfer.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.record.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/videojs/videojs.record.recorderjs.min.js') }}"></script>
		<script type="text/javascript">
var exampleAudioPlayer;
var submitAudioPlayer;
var fd;
$(document).ready(function(){
        // 원음
        const sampleAudioOptions = {
                controls: true,
                autoplay: false,
                fluid: false,
                bigPlayButton: false,
                plugins: {
                        wavesurfer: {
                                backend: 'MediaElement',
                                displayMilliseconds: false,
                                debug: true,
                                waveColor: '#086280',
                                progressColor: 'black',
                                cursorColor: 'black',
                                hideScrollbar: true
                        }
                }
        };
        exampleAudioPlayer = videojs('exampleAudioWaveSurfer', sampleAudioOptions, function() {
		exampleAudioPlayer.src({src: "{{ url_for('static', filename=wav_url) }}", type: 'audio/wav'});
        });

        exampleAudioPlayer.on("ended", function(){
                // 동시통역
                if($(".simultaneousBtn").length > 0){
                        var btnEle = $(".sequentialBtn");
                        exampleAudioPlayer.pause();
                        exampleAudioPlayer.currentTime(0)
                        submitAudioPlayer.record().stop();
                        btnEle.removeClass("recoding");
                        btnEle.text("통역시작");
                }
        });

        // 녹음
        var submitAudioOptions = {
                controls: true,
                bigPlayButton: false,
                fluid: false,
                plugins: {
                        wavesurfer: {
                                backend: 'WebAudio',
                                waveColor: '#6fffe9',
                                progressColor: 'black',
                                displayMilliseconds: true,
                                debug: true,
                                cursorWidth: 1,
                                hideScrollbar: true,
                                plugins: [
                                        WaveSurfer.microphone.create({
                                                bufferSize: 4096,
                                                numberOfInputChannels: 1,
                                                numberOfOutputChannels: 1,
                                                constraints: {
                                                        video: false,
                                                        audio: true
                                                }
                                        })
                                ]
                        },
                        record: {
                                audio: true,
                                video: false,
                                maxLength: 600,
                                displayMilliseconds: true,
                                debug: true,
                                audioEngine: 'recorder.js'
                        }
                }
        };
        submitAudioPlayer = videojs('submitAudioWaveSurfer', submitAudioOptions, function() {
        });

        submitAudioPlayer.on('ready', function(){
                submitAudioPlayer.record().getDevice();
        });

        submitAudioPlayer.on('deviceError', function() {
                console.log('device error:', submitAudioPlayer.deviceErrorCode);
        });

        submitAudioPlayer.on('error', function(element, error) {
                console.error(error);
        });

        submitAudioPlayer.on('startRecord', function() {
                console.log('started recording!');
        });

        submitAudioPlayer.on('finishRecord', function() {
                console.log('finished recording: ', submitAudioPlayer.recordedData);
        });

        // 동시 통역
        $(document).on("click", ".simultaneousBtn", function(){
                var btnEle = $(this);

                if(!btnEle.hasClass("recoding")){
                        // 녹음시작
                        exampleAudioPlayer.play();
                        submitAudioPlayer.record().start();
                        btnEle.addClass("recoding");
                        btnEle.text("녹음중/취소");
                }else{
                        // 녹음아님
                        exampleAudioPlayer.pause();
                        exampleAudioPlayer.currentTime(0)
                        submitAudioPlayer.record().stop();
                        btnEle.removeClass("recoding");
                        btnEle.text("통역시작");
                }
        });

        // 녹음본 제출
        $(document).on("click", ".submitRecordDataBtn", function(){
                // 녹음 데이터 보내기
                fd = new FormData();
                fd.append('assignment', '123');
                fd.append('wav', submitAudioPlayer.recordedData);
                $.ajax({
                        url: "https://ewha.ltra.cc/stt",
                        type: "PUT",
                        data: fd,
                        processData: false,
                        contentType: false
                }).done(function(data){
					
                });
        });
});
		</script>
{% endblock %}

{% block content %}
			<div class="contentDiv">
				<h1>동시 통역/순차 통역</h1>
				<div class="probKeywordDiv">
					<span>문제 키워드 : 테스트 키워드</span>
				</div>
				<div class="exampleAudioDiv">
					<h2>원음</h2>
					<audio id="exampleAudioWaveSurfer" class="video-js vjs-default-skin"></audio>
				</div>
				<div class="submitAudioDiv">
					<h2>내음성</h2>
					<audio id="submitAudioWaveSurfer" class="video-js vjs-default-skin"></audio>
				</div>
				<div class="recordControllerDiv">
					<!--button class="btn sequentialBtn">통역 시작</button-->
					<button class="btn simultaneousBtn">통역 시작</button>
				</div>
				<div class="recordBtnDiv btnDiv btn-2 btn-align-right">
					<button class="btn btn-cancel">임시저장</button>
					<button class="btn btn-submit submitRecordDataBtn">제출</button>
				</div>
			</div>
{% endblock %}
